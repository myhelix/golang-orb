parameters:
  source_dir:
    type: string
    default: "lambdas"
    description: "directory which contains your go code"
steps:
  - run:
      name: build lambdas
      environment:
        SOURCE_DIR: <<parameters.source_dir>>
      command: |
        mkdir -p out
        mkdir -p artifacts
        go list ./$SOURCE_DIR/... | sed 's|.*/$SOURCE_DIR/||'  | tr '/' '_' | CGO_ENABLED=0 GOOS=linux parallel --jobs 9 go build -a -installsuffix cgo -o out/{} $SOURCE_DIR/{}/*.go '&&' touch -t 198001010000 out/{} '&&' zip -Xj artifacts/{}.zip out/{} '&&' zip -ur artifacts/{}.zip config
