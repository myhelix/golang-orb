description: >
  Glide and then run tests using ginkgo

parameters:
  environment:
    description: what runner to run on
    type: string
  golang_version:
    type: enum
    enum: ['1.13.15', '1.14.15', '1.15.10', '1.16.2']
    description: >
      NOTE these are installed by https://github.com/myhelix/circleci-runner/blob/master/lib/circleci-runner-stack.ts#L152..L156
  org:
    type: string
    default: myhelix
  project_name:
    type: string
    description: "Project name, must match github repo name"
  test_type:
    description: The test type to run.
    type: enum
    enum: ['acceptance', 'unit']

# Use the runner
machine: true
resource_class: << parameters.org >>/<< parameters.environment >>

environment:
  ENVIRONMENT: << parameters.environment >>
  GOENV_VERSION: << parameters.golang_version >>
  PROJECT_NAME: << parameters.project_name >>
  TEST_TYPE: <<parameters.test_type>>
  GO_ENV: << parameters.environment >>

working_directory: /home/circleci/go/<< parameters.golang_version >>/src/github.com/<< parameters.org >>/<< parameters.project_name >>

steps:
  - checkout
  - run:
      name: setup golang
      command: goenv version
  - glide-install
  - run:
      name: install ginkgo
      command: |
        if [ -z "$(which ginkgo)" ]; then
          echo "Installing ginkgo"
          go get -u github.com/onsi/ginkgo/ginkgo
        fi
    - run:
        name: run test
        command: <<include(scripts/test.sh)>>
